{% extends 'base.html' %}
{% load humanize %}
{% load static %}
{% block title %}
  {{ board.name }} - {{ block.super }}
{% endblock %}
{% block hjavascript %}
<script>   
    $(document).ready(function(){
        var loadData = document.getElementById("loadData");
        loadData.parentNode.removeChild(loadData);
    });
</script>
{% endblock %}
{% block breadcrumb %}
  <li class="breadcrumb-item"><a href="{% url 'boards:home' %}">板块</a></li>
  <li class="breadcrumb-item active">{{ board.name }}</li>
  <li class="ml-auto">
    <span>
        <form align="left"  id="myform">
            {% csrf_token %}
            <input id="code" name="code" type="text" placeholder="股票代码" 
              autofocus required size="6"> 
            <button type="submit" class="btn btn-success" >查询</button>
        </form>
    </span>
  </li>
{% endblock %}

{% block content %}

  <table class="table">
    <thead class="thead-inverse">
      <tr>
        <th>股票代码</th>
        <th>股票名称</th>
        <th>涨跌幅%</th>
        <th>委比%</th>
        <th>主力净流入(万)</th>
        <th>北向净流入(万)</th>
        <th>涉及板块</th>
      </tr>
    </thead>
    <tbody>
      {% for stock in stockses %} 
        {% url 'boards:stock_detail' board.name stock.name as stock_url %}
        <tr>
          <td>
            <p class="mb-0">
              <a href="{{ stock_url }}">{{ stock.code }}</a>
            </p>
          </td>
          <td>{{ stock.name }}</td>
          <td class="align-middle">
            {% if stock.growth > 0 %}
               <span style="color:red">{{ stock.growth }}</span>
            {% else %}
               <span style="color:green">{{ stock.growth }}</span>
            {% endif %}
          </td>
          <td class="align-middle">
            {% if stock.committee > 0 %}
               <span style="color:red">{{ stock.committee }}</span>
            {% else %}
               <span style="color:green">{{ stock.committee }}</span>
            {% endif %}
          </td>
          <td class="align-middle">
            {% if stock.inflow > 0 %}
               <span style="color:red">{{ stock.inflow }}</span>
            {% else %}
               <span style="color:green">{{ stock.inflow }}</span>
            {% endif %}
          </td>
          <td class="align-middle">
            {% if stock.nf > 0 %}
               <span style="color:red">{{ stock.nf }}</span>
            {% else %}
               <span style="color:green">{{ stock.nf }}</span>
            {% endif %}
          </td>
          <td class="align-middle">
            {% with boards=stock.boards %}
              {% if boards %}
                <small>
                  {% for b in boards.all %}
                  <a href="{% url 'boards:board_stocks' b.name %}">{{ b.name }}</a> ,
                  {% endfor %}
                </small>
              {% else %}
                <small class="text-muted">
                  <em></em>
                </small>
              {% endif %}
            {% endwith %}
        </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
  {% include 'includes/pagination.html' %}
  <center>
    <div id="loadData">数据加载中......</div>
    <!-- 为ECharts准备一个具备大小（宽高）的容器 -->
    <div style="width:100%;height:1500px;margin-top:50px;">
        <div id="hist_futu" style="float:left;width: 100%;height:1400px;"></div>
    </div>
  </center>
  <div class="modal fade" id="lengthModel">
    <div class="modal-dialog">
        <div class="modal-content message_align" style="width:400px;height:80px;margin-top:220px;margin-left:130px">
            <div class="modal-header" style="text-align:left;font-size:small;height:3px;margin-bottom:1px">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="margin-top:-30px"><span
                        aria-hidden="true">×</span></button>
            </div>
            <div class="modal-body" style="text-align: center;font-size:16px;height: 18px;color:chocolate">
                <p style="margin-top:-15px">"股票代码长度" 不正确</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" data-dismiss="modal">确定</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->
  <div class="modal fade" id="notfindModel">
    <div class="modal-dialog">
        <div class="modal-content message_align" style="width:400px;height:80px;margin-top:220px;margin-left:130px">
            <div class="modal-header" style="text-align:left;font-size:small;height:3px;margin-bottom:1px">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="margin-top:-30px"><span
                        aria-hidden="true">×</span></button>
            </div>
            <div class="modal-body" style="text-align: center;font-size:16px;height: 18px;color:chocolate">
                <p style="margin-top:-15px">该板块没有找到查询的个股!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" data-dismiss="modal">确定</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->
  <div class="modal fade" id="preModel">
    <div class="modal-dialog">
        <div class="modal-content" style="width:400px;height:80px;margin-top:220px;margin-left:130px">
            <div class="modal-header" style="text-align:left;font-size:small;height:3px;margin-bottom:1px">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="margin-top:-30px"><span
                    aria-hidden="true">×</span></button>
            </div>
            <div class="modal-body" style="text-align: center;font-size:16px;height: 18px;color:chocolate">
                <p style="margin-top:-15px">正在查询中，请耐心等待......</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success">查询结束将关闭</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->
{% endblock %}

{% block javascript %}
    <script src="{% static 'js/echarts.min.js' %}"></script>
    <script>
        var myChart = echarts.init(document.getElementById("hist_futu"));
        var app = {};///
       
        var option;

        const bsignals_state = ['买入', '卖出', '买入', '卖出', '买入', '卖出','买二', '卖二','买三', '卖三','买四', '卖四', '买五', '卖五','买六', '卖六', '买七', '卖七'];
        const bcolors_state = ['#FFD700', '#000000', '#f905d9', '#1d9605','#ff6600','#00ccff','#C02906', '#0033CC','#cc6600', '#336600','#ff9900','#ccff00','#ffcccc','#ccffcc','#9900cc','#00ccff','#ff0066','#00ff99'];

        var upColor = '#ec0000';
        var upBorderColor = '#8A0000';
        var downColor = '#00da3c';
        var downBorderColor = '#008F28';
        var data = {{ data|safe }}
        var blockid = '{{ board.id|safe }}';
        var blocktypename = '{{ board.type.name|safe }}';
        var signals = {{ bsignals|safe }};
       
        var data0 = null;

        if(data.length==0){
            data0 = JSON.parse(sessionStorage.getItem('block'+blockid)); 
            if (data0 == null){
                // 临时获取后端板块数据
                $(document).ready(function(){
                    $.ajaxSetup({
                        data: {csrfmiddlewaretoken: '{{ csrf_token }}' },
                    });
                    $.ajax({
                        type:"POST",
                        data: {blockid:blockid},
                        url: "{% url 'boards:blockget' %}",
                        cache: false,
                        dataType: "json",
                        async:false,
                        success: function (res) {
                            if (res.data && !res.data.result){
                                data0 =splitData(JSON.parse(res.data)); 
                                if(blocktypename !='大盘'){
                                    if(sessionStorage.length>1){
                                        sessionStorage.clear() 
                                    }
                                    sessionStorage.setItem('block'+blockid, JSON.stringify(data0));
                                    sessionStorage.setItem('bsignals'+blockid, JSON.stringify(JSON.parse(res.bsignals)));
                                }
                                signals =  JSON.parse(res.bsignals);

                                runChart();
                            }
                        },
                        error: function (msg) {
                            alert(JSON.stringify(msg));
                        }
                    });
    
                });
            }
            signals =  JSON.parse(sessionStorage.getItem('bsignals'+blockid)); 
        }else{
            data0 = splitData(data);
            if(blocktypename !='大盘'){
                if(sessionStorage.length>1){
                    sessionStorage.clear() 
                }
                sessionStorage.setItem('block'+blockid, JSON.stringify(data0));
                sessionStorage.setItem('bsignals'+blockid, JSON.stringify(signals));
            }
        }
        
        function splitData(rawData) {
            var open_close_low_high = []
            var volumes = []
            var date = []
        
            for (var i = 0; i < rawData.length; i++) {
                open_close_low_high.push([rawData[i].open, rawData[i].close, rawData[i].low, rawData[i].high,rawData[i].vol,rawData[i].trade_date,rawData[i].pe])
                volumes.push(rawData[i].vol)
                date.push(rawData[i].trade_date)
            }
        
            return {
                'open_close_low_high': open_close_low_high,
                'volumes': volumes,
                'date': date,
                'name': rawData[0].name
            }
        }
        
        
        // 计算均量线
        function calculateVOL(dayCount, data) {
	        var result = [0];
    
	        for (var i = 1; i < data.length; i++) {
		        if (i < dayCount) {
			        result.push('-');
			        continue;
		        }
		        var sum = 0;
		        for (var j = 0; j < dayCount; j++) {
			        sum += +data[i - j][4];
		        }
		        result.push((sum / dayCount).toFixed(2));
	        }

	        return result;
        } 

        // 计算平均线
        function calculateMA(dayCount, data) {
	        var result = [];
	        for (var i = 0, len = data.length; i < len; i++) {
		        if (i < dayCount) {
			      result.push('-');
			      continue;
		        }
		        var sum = 0;
		        for (var j = 0; j < dayCount; j++) {
			        sum += +data[i - j][1];
		        }
                result.push(parseFloat((sum / dayCount).toFixed(2)));
	        }
	
	        return result;
        }
       
        // 平滑移動平均線
        function calculateEMA(dayCount, data) {
            var ema = [0];
        
            for (var i = 1; i < data.length; i++) {
                var todayEMA = (2 / (dayCount + 1) * data[i][1]) +
                            ((dayCount - 1) / (dayCount + 1) * ema[i - 1]);
        
                ema.push(todayEMA.toFixed(2));
            }
        
            return ema;
        }

        function calculateMACD(data) {
            // 第一天全部为0
            var dif = [0];
            var dea = [0];
            var osc = [0];
        
            var ema12 = calculateEMA(6, data);
            var ema26 = calculateEMA(13, data);
        
            // 第三天开始
            for (var i = 1; i < data.length; i++) {
                dif.push((ema12[i] - ema26[i]).toFixed(2));
                dea.push((dea[i - 1] * 0.8 + dif[i] * 0.2).toFixed(2));
                osc.push((2 * (dif[i] - dea[i])).toFixed(2));
            }
        
            return {
                'DIF': dif,
                'DEA': dea,
                'OSC': osc
            }
        }

        function barColor(oscData) {
            var res = []
            for (var i = 0; i < oscData.length; i++) {
                if (oscData[i] > 0) {
                    res.push({
                        value: oscData[i],
                        itemStyle: {
                            color: '#FF0000'
                        }
                    })
                } else {
                    res.push({
                        value: oscData[i],
                        itemStyle: {
                            color: '#00FF00'
                        }
                    })
                }
            }
            return res;
        }

        function volumeColor(open_close) {
            const upColor = '#ec0000';
            const downColor = '#00da3c';
        
            var result = []
            for (var i = 0; i < open_close.length; i++) {
                result.push({
                    value:  open_close[i][4],
                    itemStyle: {
                        color: open_close[i][0] >= open_close[i][1] ? downColor : upColor
                    }
                })
            }
        
            return result
        }

        /**
         * 通过Signal做买入，卖出点
         */
         function cciAnalysis1(signals) {
	        var result = [];
           
            let cci1 = Object.values(signals.cci1);
            let buy = Object.values(signals.buy_signal);
            let sell = Object.values(signals.sell_signal);
            let mdibuy = Object.values(signals.mdibuy_signal);
            let mdisell = Object.values(signals.mdisell_signal);
            let ccibuy = Object.values(signals.cci84buy_signal);
            let ccisell = Object.values(signals.cci84sell_signal);
            let ybuy = Object.values(signals.ybuy_signal);
            let ysell = Object.values(signals.ysell_signal);
            let skdjbuy = Object.values(signals.skdjbuy_signal);
            let skdjsell = Object.values(signals.skdjsell_signal);
            let willrbuy = Object.values(signals.willrbuy_signal);
            let willrsell = Object.values(signals.willrsell_signal);
            let mfibuy = Object.values(signals.mfibuy_signal);
            let mfisell = Object.values(signals.mfisell_signal);
            let obvbuy = Object.values(signals.obvbuy_signal);
            let obvsell = Object.values(signals.obvsell_signal);
            let htbuy = Object.values(signals.htbuy_signal);
            let htsell = Object.values(signals.htsell_signal);

            
	        for (var i = 0; i < cci1.length-1; i++) {
		        if(cci1[i] != null){
                    if(buy[i] == 1){
                        result.push(0);
                    }else if(sell[i]==1){
                        result.push(1);
                    }else if(mdibuy[i]==1){
                        result.push(2);
                    }else if(mdisell[i]==1){
                        result.push(3);
                    }else if(ccibuy[i]==1){
                        result.push(4);
                    }else if(ccisell[i]==1){
                        result.push(5);
                    }else if(ybuy[i]==1){
                        result.push(6);
                    }else if(ysell[i]==1){
                        result.push(7);
                    }else if(skdjbuy[i]==1){
                        result.push(8);
                    }else if(skdjsell[i]==1){
                        result.push(9);
                    }else if(willrbuy[i]==1){
                        result.push(10);
                    }else if(willrsell[i]==1){
                        result.push(11);
                    }else if(mfibuy[i]==1){
                        result.push(12);
                    }else if(mfisell[i]==1){
                        result.push(13);
                    }else if(obvbuy[i]==1){
                        result.push(14);
                    }else if(obvsell[i]==1){
                        result.push(15);
                    }else if(htbuy[i]==1){
                        result.push(16);
                    }else if(htsell[i]==1){
                        result.push(17);
                    }else{
                        result.push('-');
                    }
                }else{
                    result.push('-');
                }
	        }
	        return result
        }

        function cciAnalysis2(signals) {
	        var result = [];
           
            let cci2 = Object.values(signals.cci2);
            let ybuy = Object.values(signals.ybuy_signal);
            let ysell = Object.values(signals.ysell_signal);
            
	        for (var i = 0; i < cci2.length-1; i++) {
		        if(cci2[i] != null){
                    if(ybuy[i] == 1){
                        result.push(6);
                    }else if(ysell[i]==1){
                        result.push(7);
                    }else{
                        result.push('-');
                    }
                }else{
                    result.push('-');
                }
	        }
	        return result
        }

        function formatCCIAnalysis1(signal, cciData, date) {
            var result = []
         
            for (var i = 0; i < signal.length-1; i++) {
                 
                if (signal[i] !== '-') {
                    result.push({
                        symbolSize: 70,
                        yAxis: cciData[i],
                        xAxis: date[i],
                        value: bsignals_state[signal[i]],
                        itemStyle: {
                            color: bcolors_state[signal[i]],
                            shadowColor: '#FFFFFF',
                            shadowBlur: 20
                        },
                        animation: true
                    })
                }
            }
        
            return result
        }

        function formatCCIAnalysis2(signal, cciData, date) {
            var result = []
         
            for (var i = 0; i < signal.length-1; i++) {
                 
                if (signal[i] !== '-') {
                    result.push({
                        symbolSize: 70,
                        yAxis: cciData[i],
                        xAxis: date[i],
                        value: bsignals_state[signal[i]],
                        itemStyle: {
                            color: bcolors_state[signal[i]],
                            shadowColor: '#FFFFFF',
                            shadowBlur: 20
                        },
                        animation: true
                    })
                }
            }
        
            return result
        }

        function runChart() {
            option = {
                title: {
                    text: data0.name
                },
                animation: false,
                legend: {
                    top: 10,
                    data: ['日K', 'MA5', 'MA12','MA25','MA120']
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    borderWidth: 1,
                    borderColor: '#ccc',
                    padding: 10,
                    textStyle: {
                        color: '#000'
                    },
                    position: function (pos, params, el, elRect, size) {
                        const obj = {
                            top: 10
                        };
                        obj[['left', 'right'][+(pos[0] < size.viewSize[0] / 2)]] = 30;
                        return obj;
                    }
                },
                axisPointer: {
                    link: [
                        {
                            xAxisIndex: 'all'
                        }
                    ],
                    label: {
                        backgroundColor: '#777'
                    }
                },
                toolbox: {
                    feature: {
                        dataZoom: {
                            yAxisIndex: false
                        },
                        brush: {
                            type: ['lineX', 'clear']
                        }
                    }
                },
                brush: {
                    xAxisIndex: 'all',
                    brushLink: 'all',
                    outOfBrush: {
                        colorAlpha: 0.1
                    }
                },
                visualMap: {
                    show: false,
                    seriesIndex: 5,
                    dimension: 2,
                    pieces: [
                        {
                            value: 1,
                            color: downColor
                        },
                        {
                            value: -1,
                            color: upColor
                        }
                    ]
                },
                grid: [
                   {
                    left: '10%',
                    right: '8%',
                    height: '31%'
                   },
                   {
                    left: '10%',
                    right: '8%',
                    top: '37%',
                    height: '11%'
                   },
                   {
                    left: '10%',
                    right: '8%',
                    top: '48%',
                    height: '10%'
                   },
                   {
                    left: '10%',
                    right: '8%',
                    top: '61%',
                    height: '10%'
                   },
                   {
                    left: '10%',
                    right: '8%',
                    top: '71%',
                    height: '12%'
                   },
                   {
                    left: '10%',
                    right: '8%',
                    top: '82%',
                    height: '13%'
                   }      
                ],
                xAxis: [
                    {
                        type: 'category',
                        data: data0.date,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        splitLine: { show: false },
                        min: 'dataMin',
                        max: 'dataMax',
                        axisPointer: {
                            z: 100
                        }
                    },
                    {
                        type: 'category',
                        gridIndex: 1,
                        data: data0.date,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        axisTick: { show: false },
                        splitLine: { show: false },
                        axisLabel: { show: false },
                        min: 'dataMin',
                        max: 'dataMax'
                    },
                    {
                        type: 'category',
                        gridIndex: 2,
                        data: data0.date,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        axisTick: { show: false },
                        splitLine: { show: false },
                        axisLabel: { show: false },
                        min: 'dataMin',
                        max: 'dataMax'
                    },
                    {
                        type: 'category',
                        gridIndex: 3,
                        data: data0.date,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        axisTick: { show: false },
                        splitLine: { show: false },
                        axisLabel: { show: false },
                        min: 'dataMin',
                        max: 'dataMax'
                    },
                    {
                        type: 'category',
                        gridIndex: 4,
                        data: data0.date,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        axisTick: { show: false },
                        splitLine: { show: false },
                        axisLabel: { show: false },
                        min: 'dataMin',
                        max: 'dataMax'
                    },
                    {
                        type: 'category',
                        gridIndex: 5,
                        data: data0.date,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        axisTick: { show: false },
                        splitLine: { show: false },
                        axisLabel: { show: false },
                        min: 'dataMin',
                        max: 'dataMax'
                    }
                ],
                yAxis: [
                    {
                        scale: true,
                        splitArea: {
                            show: true
                        }
                    },
                    {
                        scale: true,
                        gridIndex: 1,
                        splitNumber: 2,
                        axisLabel: { show: false },
                        axisLine: { show: false },
                        axisTick: { show: false },
                        splitLine: { show: false }
                    },
                    {
                        scale: true,
                        gridIndex: 2,
                        splitNumber: 2,
                        axisLabel: { show: false },
                        axisLine: { show: false },
                        axisTick: { show: false },
                        splitLine: { show: false }
                    },
                    {
                        scale: true,
                        gridIndex: 3,
                        splitNumber: 2,
                        axisLabel: { show: false },
                        axisLine: { show: false },
                        axisTick: { show: false },
                        splitLine: { show: false }
                    },
                    {
                        scale: true,
                        gridIndex: 4,
                        splitNumber: 2,
                        axisLabel: { show: false },
                        axisLine: { show: false },
                        axisTick: { show: false },
                        splitLine: { show: false }
                    },
                    {
                        scale: true,
                        gridIndex: 5,
                        splitNumber: 2,
                        axisLabel: { show: false },
                        axisLine: { show: false },
                        axisTick: { show: false },
                        splitLine: { show: false }
                    }
                ],
                dataZoom: [
                    {
                        type: 'inside',
                        xAxisIndex: [0, 1, 2, 3, 4, 5],
                        start: 100 - Math.floor((60 / data0.date.length) * 100),
                        end: 100
                    },
                    {
                        show: true,
                        xAxisIndex: [0, 1, 2, 3, 4, 5],
                        type: 'slider',
                        top: '95%',
                        start: 100 - Math.floor((60 / data0.date.length) * 100),
                        end: 100
                    }
                ],
                series: [
                    {
                        name: '日K',
                        type: 'candlestick',
                        data: data0.open_close_low_high,
                        itemStyle: {
                            color: upColor,
                            color0: downColor,
                            borderColor: upBorderColor,
                            borderColor0: downBorderColor
                        },
                        tooltip: {
                            formatter: function (param) {
                                param = param[0];
                                return [
                                    'Date: ' + param.name + '<hr size=1 style="margin: 3px 0">',
                                    'Open: ' + param.data[0] + '<br/>',
                                    'Close: ' + param.data[1] + '<br/>',
                                    'Lowest: ' + param.data[2] + '<br/>',
                                    'Highest: ' + param.data[3] + '<br/>'
                                ].join('');
                            }
                        }
                    },
                    {
                        name: 'MA5',
                        type: 'line',
                        data: calculateMA(5,data0.open_close_low_high),
                        smooth: true,
                        lineStyle: {
                            opacity: 0.5
                        }
                    },
                    {
                        name: 'MA12',
                        type: 'line',
                        data: calculateMA(12,data0.open_close_low_high),
                        smooth: true,
                        lineStyle: {
                            opacity: 0.5
                        }
                    },
                    {
                        name: 'MA25',
                        type: 'line',
                        data: calculateMA(25,data0.open_close_low_high),
                        smooth: true,
                        lineStyle: {
                            opacity: 0.5
                        }
                    },
                    {
                        name: 'MA120',
                        type: 'line',
                        data: calculateMA(120,data0.open_close_low_high),
                        smooth: true,
                        lineStyle: {
                            opacity: 0.5
                        }
                    },
                    {
                        name: '成交量',
                        type: 'bar',
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        data: volumeColor(data0.open_close_low_high),
                    },
                    {
                        name: '5日均量线',
                        type: 'line',
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        color: '#ed9ffc',
                        smooth: true,
                        showSymbol: false,
                        lineStyle: {
                            width: 1
                        },
                        data: calculateVOL(5,data0.open_close_low_high)
                    },
                    {
                        name: '60日均量线',
                        type: 'line',
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        color: '#FFFF00',
                        smooth: true,
                        showSymbol: false,
                        lineStyle: {
                            width: 1
                        },
                        data: calculateVOL(60,data0.open_close_low_high)
                    },
                    {
                        name: 'MACD',
                        type: 'bar',
                        xAxisIndex: 2,
                        yAxisIndex: 2,
                        color: '#FF0000',
                        data: barColor(calculateMACD(data0.open_close_low_high).OSC)
                    },
                    {
                        name: 'DIF',
                        type: 'line',
                        xAxisIndex: 2,
                        yAxisIndex: 2,
                        color: '#e9b002',
                        smooth: true,
                        showSymbol: false,
                        lineStyle: {
                            width: 1
                        },
                        data: calculateMACD(data0.open_close_low_high).DIF
                    },
                    {
                        name: 'DEA',
                        type: 'line',
                        xAxisIndex: 2,
                        yAxisIndex: 2,
                        color: '#0099FF',
                        smooth: true,
                        showSymbol: false,
                        lineStyle: {
                            width: 1
                        },
                        data: calculateMACD(data0.open_close_low_high).DEA
                    },
                    {
                        name: 'CCI1',
                        type: 'line',
                        xAxisIndex: 3,
                        yAxisIndex: 3,
                        color: '#e9b002',
                        smooth: true,
                        showSymbol: false,
                        lineStyle: {
                            width: 1
                        },
                        data: Object.values(signals.cci1),
                        markPoint: {
                            data: formatCCIAnalysis1(cciAnalysis1(signals), Object.values(signals.cci1), data0.date)
                        }
                    },
                    {
                        name: 'CCI2',
                        type: 'line',
                        xAxisIndex: 3,
                        yAxisIndex: 3,
                        color: '#0099FF',
                        smooth: true,
                        showSymbol: false,
                        lineStyle: {
                            width: 1
                        },
                        data: Object.values(signals.cci2),
                        markPoint: {
                            data: formatCCIAnalysis2(cciAnalysis2(signals), Object.values(signals.cci2), data0.date)
                        }
                    },
                    {
                        name: 'PDI',
                        type: 'line',
                        xAxisIndex: 4,
                        yAxisIndex: 4,
                        color: '#e9b002',
                        smooth: true,
                        showSymbol: false,
                        lineStyle: {
                            width: 1
                        },
                        data: Object.values(signals.pdi)
                    },
                    {
                        name: 'MDI',
                        type: 'line',
                        xAxisIndex: 4,
                        yAxisIndex: 4,
                        color: '#00ffff',
                        smooth: true,
                        showSymbol: false,
                        lineStyle: {
                            width: 1
                        },
                        data: Object.values(signals.mdi)
                    },
                    {
                        name: 'ADX',
                        type: 'line',
                        xAxisIndex: 4,
                        yAxisIndex: 4,
                        color: '#cc00ff',
                        smooth: true,
                        showSymbol: false,
                        lineStyle: {
                            width: 1
                        },
                        data: Object.values(signals.adx)
                    },
                    {
                        name: 'ADXR',
                        type: 'line',
                        xAxisIndex: 4,
                        yAxisIndex: 4,
                        color: '#009933',
                        smooth: true,
                        showSymbol: false,
                        lineStyle: {
                            width: 1
                        },
                        data: Object.values(signals.adxr)
                    },
                    {
                        name: '市盈率',
                        type: 'line',
                        xAxisIndex: 5,
                        yAxisIndex: 5,
                        color: '#009933',
                        smooth: true,
                        showSymbol: false,
                        lineStyle: {
                            width: 1
                        },
                        data: data0.open_close_low_high.map(function(row) {return row[6];})
                    }
                ]
              };
    
              option && myChart.setOption(option)
    
              window.addEventListener('resize', () => {
                myChart.resize()
              })
        }

        if( data0 != null){
            runChart()
        }
        // 临时获取后端板块数据
    </script>
    <script>
        $(document).ready(function(){
            $.ajaxSetup({
                data: {csrfmiddlewaretoken: '{{ csrf_token }}' },
            });

            $('#myform').submit(function(){
                var code = $("#code").val();
                var blockname = "{{ board.name }}";
                
                if( code.length != 6 ){
                    $('#lengthModel').modal({backdrop: 'static', keyboard: false});
                    $('#lengthModel').modal('show');
                    setTimeout(function(){
                        $('#lengthModel').modal('hide');  
                    }, 3000); //ms为单位
                }else{
                    $.ajax({
                        type:"POST",
                        data: {code:code,blockname:blockname},
                        url: "{% url 'boards:query' %}",
                        cache: false,
                        dataType: "json",
                        success: function (res) {
                            if (res.data){
                                var data = JSON.parse(res.data); 
                                if (data.result=="success"){
                                    var stockname = data.stockname;
                                    location = "/boards/"+blockname+"/stocks/"+stockname+"/";
                                }else{
                                    $('#notfindModel').modal('show');
                                    setTimeout(function(){
                                        $('#notfindModel').modal('hide');  
                                    }, 3000); //ms为单位
                                }
                            }
                        },
                        error: function (msg) {
                            alert(JSON.stringify(msg));
                        }
                    });
                }          
                return false;    
            });
        });
    </script> 
{% endblock %}
